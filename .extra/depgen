#!/bin/bash
set -e
source .extra/namegen
declare -- name wild shname
genname name "$1"
genwild wild "$name"
genshname shname "$wild"
declare -- path wpath shpath
genname path "${installabs}"
genwild wpath "$path"
genshname shpath "$wpath"
set +e
IFS= read -d '' info <<'EOF'
#this file is automatically created and modified,
#please do not modify or delete it yourself.
EOF
set -e
declare -- ruledep trail
if test -f "${installabs}/lib64/libcustomutils.so"; then
	ruledep="$(cc -I "${installabs}/include/" -M "$1.cpp")" || exit $?
	trail="-I ${shpath}/include/ -L ${shpath}/lib64/ -Wl,-rpath,${shpath}/lib64/ -Wl,-lcustomutils"
else
	ruledep="$(cc -I "$(pwd)/libs/include/" -M "$1.cpp")" || exit $?
	trail=$'-I "$$(pwd)/libs/include/" -L "$$(pwd)/libs/" -Wl,-rpath,\'$$ORIGIN/libs/\' -Wl,-l:.shared.so'
fi
ruledep="${ruledep/"$1.o"/"$name.o"}"
ruledep="${ruledep/"$1.cpp"/"$name.cpp"}"
declare -- rule="$info"$'\n'"$ruledep"
rule+=$'\n\t'"\$(if \$(wildcard $wild.mk.2),,$0 $shname)"
rule+=$'\n\t'"gcc -std=c++2a -O3 -Wall -Wextra -o $shname.o $shname.cpp -lstdc++ -Wl,--disable-new-dtags $trail"
echo "generating $1.mk.2"
touch "$1.mk.2"
.extra/proc/goup "$1.mk.2"
echo "$rule" >".$1.mk"
