#!/bin/bash
declare -- name="${1//'*'/'\*'}"
name="${name//'$'/'$$'}"
name="${name//'('/'$('}"
name="${name//')'/'$)'}"
name="${name//'$('/'$(open)'}"
name="${name//'$)'/'$(close)'}"
name="${name//'\'/'$(slash)'}"
name="${name//' '/'\ '}"
declare -- shname="${name//'$(slash)'/'$(slash)$(slash)'}"
shname="${shname/'$$'/'$(slash)$$'}"
shname="${shname//'"'/'$(slash)"'}"
shname="${shname//\'/'$(slash)'\'}"
shname="${shname//'$(open)'/'$(slash)$(open)'}"
shname="${shname//'$(close)'/'$(slash)$(close)'}"
declare -- path="${installabs//'*'/'\*'}"
path="${path//'$'/'$$'}"
path="${path//'('/'$('}"
path="${path//')'/'$)'}"
path="${path//'$('/'$(open)'}"
path="${path//'$)'/'$(close)'}"
path="${path//'\'/'$(slash)'}"
path="${path//' '/'\ '}"
declare -- shpath="${path//'$(slash)'/'$(slash)$(slash)'}"
shpath="${shpath//'$$'/'$(slash)$$'}"
shpath="${shpath//'"'/'$(slash)"'}"
shpath="${shpath//'$(open)'/'$(slash)$(open)'}"
shpath="${shpath//'$(close)'/'$(slash)$(close)'}"
shpath="${shpath//\'/'$(slash)'\'}"
IFS= read -d '' info <<'EOF'
#this file is automatically created and modified,
#please do not modify or delete it yourself.
EOF
declare -- ruledep trail
if test -f "${installabs}/lib64/libcustomutils.so"; then
	ruledep="$(cc -I "${installabs}/include/" -M "$1.cpp")" || exit $?
	trail="-I ${shpath}/include/ -L ${shpath}/lib64/ -Wl,-rpath,${shpath}/lib64/ -Wl,-lcustomutils"
else
	ruledep="$(cc -I "$(pwd)/libs/include/" -M "$1.cpp")" || exit $?
	trail=$'-I "$$(pwd)/libs/include/" -L "$$(pwd)/libs/" -Wl,-rpath,\'$$ORIGIN/libs/\' -Wl,-l:.shared.so'
fi
ruledep="$(cc -I "libs/include/" -M "$name.cpp")" || exit $?
declare -- rule="$info"$'\nnull:=\nspace:=\\ \nslash:=\\$(null)\nopen:=(\nclose:=)'
rule+=$'\n'"$ruledep"
rule+=$'\n\t'"\$(if \$(wildcard .$name.mk.2),rm .$shname.mk.2,$0 $*)"
rule+=$'\n\t'"gcc -std=c++2a -O3 -Wall -Wextra -o $shname.o $shname.cpp -lstdc++ -Wl,--disable-new-dtags $trail"
echo 'this file should only exist during make, if it still exists afterwords, \
please remove it, or run "make .refresh"' >".$1.mk.2"
echo "$rule" >".$1.mk"
