#!/bin/bash
set -e
source .extra/namegen
declare -- name wild
genname name "$targetfile"
genwild wild "$name"
if [[ ! -f "$targetfile.cpp" ]]; then
	echo hey >&2
	rm .extra/list.mk
	exit 1
fi
declare -- shname
genshname shname "$wild"
declare -- path wpath shpath
genname path "${installabs}"
genwild wpath "$path"
genshname shpath "$wpath"
set +e
IFS= read -d '' info <<'EOF'
#this file is automatically created and modified,
#please do not modify or delete it yourself.
EOF
set -e
declare -- ruledep trail
if test -f "${installabs}/lib64/libcustomutils.so"; then
	ruledep="$(cc -I "${installabs}/include/" -M "$targetfile.cpp")" || exit $?
	trail="-I ${shpath}/include/ -L ${shpath}/lib64/ -Wl,-rpath,${shpath}/lib64/ -Wl,-lcustomutils"
else
	ruledep="$(cc -I "$(pwd)/libs/include/" -M "$targetfile.cpp")" || exit $?
	trail=$'-I "$$(pwd)/libs/include/" -L "$$(pwd)/libs/" -Wl,-rpath,\'$$ORIGIN/libs/\' -Wl,-l:.shared.so'
fi
ruledep="${ruledep/"$targetfile.o"/"$name.o"}"
ruledep="${ruledep/"$targetfile.cpp"/"$name.cpp"}"
declare -- rule="$info"$'\n'"$ruledep"
rule+=$'\n\t'"\$(if \$(findstring $wild.mk.2,\$(wildcard *.mk.2)),,$0 $shname)"
rule+=$'\n\t'"gcc -std=c++2a -O3 -Wall -Wextra -o $shname.o $shname.cpp -lstdc++ -Wl,--disable-new-dtags $trail"
echo "generating $targetfile.mk.2"
touch "$targetfile.mk.2"
.extra/proc/goup "$targetfile.mk.2"
echo "$rule" >".$targetfile.mk"
